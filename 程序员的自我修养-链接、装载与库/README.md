# 一、温故而知新

## 硬件结构

1. 总线模式
   - 早期计算机硬件结构
   - cpu、内存、I/O设备控制器连接在一条总线（BUS）
2. 南北桥
   - 北桥
     - 运行速度高
     - 高速设备三袋子
   - 南桥
     - 低速设备

## 多核

1. SMP-对称多处理器
2. 多核处理器（SMP简化版）

## 计算机软件体系结构

![WechatIMG268](/Users/yp-tc-m-2548/Desktop/ReadingNotes/程序员的自我修养-链接、装载与库/WechatIMG268.jpeg)

![image](/Users/yp-tc-m-2548/Desktop/ReadingNotes/程序员的自我修养-链接、装载与库/WechatIMG269.jpeg)



1. 应用程序接口（API）
   - 开发工具与应用程序都使用
   - 提供者是运行库
2. 系统调用接口（SCI）
   - 运行库使用
   - 多以软件终端方式提供
   - 操作系统内核层提供
3. 硬件接口（硬件规格）
   - 操作系统内核层使用
   - 硬件层提供

## 操作系统

- 提供抽象接口
- 管理硬件资源

### CPU利用

1. 多道程序
2. 分时系统
3. 多任务系统
   - 进程
   - 抢占式分配方式

### 设备驱动

- 硬件驱动程序
  - 设备的细节隐藏起来，抽象成一系列概念，直接使用

## 内存

### 重点

- 地址空间是否隔离
- 内存使用效率
- 程序运行地址确认

### 分段

### 分页

- 物理页
- 磁盘页
- 虚拟页
- 操作系统决定页大小
- 页错误
  - 虚拟页不在内存中，进程需要用到对应页时，硬件捕获页错误消息
    1. 操作协同接管进程
    2. 从磁盘读出虚拟页装入内存
    3. 物理页与虚拟页简历映射

## 线程

轻量级进程

![image2](/Users/yp-tc-m-2548/Desktop/ReadingNotes/程序员的自我修养-链接、装载与库/WechatIMG270.jpeg)

### 私有空间

- 栈（一般情况下）
- 线程局部存储（TLS）
- 寄存器

### 基本状态

- 运行
  - 时间片
    - 可运行时间
- 就绪
- 等待

### 调度方式

1. 轮转法

2. 优先级调度

   - IO密集型线程
     - 频繁等待，不进行大量计算
   - CPU密集型线程
     - 与上相反

   - 饿死
   - 线程优先级改变
     - 用户指定优先级
     - 根据进入等待状态平凡程度提升或降低优先级
     - 长时间得不到执行而被提升优先级

### 可抢占线程和不可抢占线程

- 线程在用尽时间片之后会被强制剥夺继续执行的权利，进入就绪状态
- 不可抢占情况下，线程需要主动进入就绪状态
- 主动放弃执行的情况
  - 当线程试图等待某事件时
  - 线程主动放弃时间片

### Linux多线程

![](/Users/yp-tc-m-2548/Desktop/ReadingNotes/程序员的自我修养-链接、装载与库/WechatIMG271.jpeg)

- fork为写时复制
  - 两个任务可以同时自由读取内存，但任意一个任务试图修改内存时，就会copy内存，给修改方使用

### 线程安全

- 原子性
- 锁
  - 二元信号量
  - 信号量
  - 互斥量
  - 临界区
    - 只在本进程中有效，信号量和互斥量在系统的任何进程都是可见的
    - 具有和互斥量想同的性质
  - 读写锁
    - 状态
      - 自由
      - 共享
      - 独占
    - 获取方式
      - 共享
        - 多线程共享
      - 独占
        - 只能单线程
        - 若从共享转为独占，则之前所有共享的线程都释放后才可以
  - 条件变量
    - 可多个线程使用

- 多线程并发
  - 函数可重入
    - 并发安全强有力保证
    - 不使用任何静态或全局的const变量
    - 不返回任何静态或全局的const变量指针
    - 仅依赖调用方提供的参数
    - 不依赖任何单资源的锁
    - 不调用任何不可重入函数
  - 防止过度优化
    - 主要是因为CPU会对无关的代码乱序执行
      - 目前无法防范

- 多线程内部情况（用户线程与内核线程
  - 一对一
  - 多对一
    - 一个用户线程阻塞，其他的也会阻塞，因为内核线程阻塞了
  - 多对多

# 二、编译和链接

- 构建
  - 编译和链接合并到一起的过程成为构建

## 程序构建过程

![](/Users/yp-tc-m-2548/Desktop/ReadingNotes/程序员的自我修养-链接、装载与库/WechatIMG272.jpeg)

1. 预编译
   - 生成预处理文件
   - 有的语言并没有预处理，有预处理的语言，它的红替换和文件包含等工作一般不归入编译器范围，而是独立的预处理器
2. 编译
   - 步骤
     - 词法分析
     - 语法分析
     - 语义分析
     - 优化
   - 生成汇编文件
3. 汇编
   - 汇编代码转换为机器可以执行的指令（未链接）
4. 链接
   - 将指令与库链接生成可执行文件

## 编译器

1. 词法分析
   - 过程
     1. 输入扫描器
     2. 标示符放到符号表
     3. 数字字符常量放到文字表
     4. 运行有限状态机分割代码
     5. 生成一系列记号
   - 类别
     - 关键字
     - 标示符
     - 字面量（数字、字符串等）
     - 特殊符号（运算符号等）
   - lex可实现词法扫描
2. 语法分析
   - 过程
     1. 语法分析器对极好进行语法分析
     2. 产生语法树
        - 以表达式为节点的树
     3. 整个过程采用上下文无关语法
   - lex可实现语法分析
3. 语义分析
   - 过程
     1. 语义分析器对语法树做静态语义分析
        - 静态语义
          - 编译器能做的分析
          - 编译期
        - 动态语义
          - 运行期
     2. 声明和类型的匹配、类型的转换
     3. 经过语义分析阶段后，语法树的表达式都被标示了类型，隐式转换也在改步骤中完成
4. 中间语言生成
   - 源码级优化器
     - 语法树转换为中间代码
     - 很接近目标代码，但与目标及其和运行时环境无关（数据尺寸，变量地址，寄存器名称等）
   - 类别
     - 三地址码
       - x = y op z
       - 一个表达式中有三个变量地址，会生成多个临时变量
     - P-代码
   - 使编译器可以被分为前端和后端
     - 前端负责产生及其无关的中间代码
     - 后端将中间代码转换为目标及其代码
     - 这样对于一些跨平台编译器，可以针对不同平台使用同一个前端编译器和多个后端编译器
5. 目标代码生成与优化
   - 编译器后端主要包括代码生成器、目标代码优化器
     - 代码生成器
       - 中间代码转换为目标机器代码，依赖目标机器
     - 目标代码优化器
       - 对上述目标代码优化
         - 选择合适的寻址方式、使用位移替代乘法运算、删除多余指令等

## 链接器

- 符号
  - 随着汇编语言的普及被使用，标示一个地址，可能是程序的起始地址，也可能是变量的

- 模块拼装-静态链接
  - 地址和空间分配
  - 符号决议（符号绑定、名称保定、名称决议、地址绑定、指令绑定）
  - 重定位
    - 被修正的地方叫重定位入口
  - 目标文件和库一起链接形成最终的可执行文件
    - 库最常见的就是运行时库
    - 库是一组目标文件