---
title："iOS-应用加载"
categories:
- iOS
---

# 前导知识

## Mach-O

**Mach object** 文件 用于记录可执行文件、对象代码、共享库、动态加载代码和内存转储的文件格式。

.out的替代，**Mach-O** 提供了更好的扩展性，并提升了符号表中信息的访问速度。

### 文件类型

#### **Executable**

**app** 的二进制主文件，同时也是 **app extension** 的二进制主文件。

#### **Dylib**

**dylib** 是动态库，在其他平台也叫 **DSO** 或者 **DLL**。

**Xcode 7** 之前，**.dylib** 文件一般是引入的 **库文件**，之后改为了 **.tbd**。

**.dylib & .tbd**

**.dylib** 文件是项目中真正使用到的二进制库文件，它位于用户设备上的 **/usr/lib** 目录下。

**.tbd** 文件是项目中的一个文本文件，用于链接到真正 **.dylib**。

因为 **文本文件** 的大小远远小于 **二进制文件** 的大小，所以让 **Xcode** 的 **SDK** 的下载大小更小。

**Static frameworks & Dynamic frameworks**

**静态库**在 **编译期** 进行链接，**动态库** 在 **运行期** 链接。

* 静态库：链接阶段会将汇编生成的目标文件与引用的库一起链接打包进可执行文件中。
* 动态库：程序编译并不会链接到目标代码中，在程序可执行文件里面会保留对动态库的引用。
  * 动态链接库：在没有被加载到内存的前提下，当可执行文件被加载，动态库也随着被加载到内存中。
    * Linked Framework and Libraries 的 share libraries
    * 随着程序启动而启动
  * 动态加载库：当需要的时候再使用 dlopen 等通过代码或者命令的方式来加载。
    * 在程序启动之后

#### **Bundle**

Bundle 是一种特殊类型的 dylib，你是无法对其进行链接的。你所能做的是在 Runtime 运行时去通过 dlopen 来加载它。

### Imgae & Framework

**Image**： 以上三种类型文件

**Framework**：dylib和其相关的资源及头文件组成的文件

### 编译过程

1. 源代码
2. 预编译
3. 编译
4. 汇编
5. 链接
6. 可执行文件

### Mach-O 文件结构

#### **segments**

**Mach-O 文件** 由 **segments** 段组成。

* 名称：**大写格式**
* 空间：**page size** 的倍数
  * A7 和 A8之后是16kb
  * A9 之后物理内存分页大小16kb
  * 其他4kb

**逻辑地址空间** & **虚拟地址空间** 空间大小由作系统位数决定。

**虚拟地址空间**会被分为**相同大小**的块，这些块被称为**内存页（page）**。

**计算机处理器和它的内存管理单元（MMU - memory management uinit）**维护着一张将程序的**逻辑地址空间映射到物理地址**上的分页表 **page table**

#### **section**

**segment** 段内部还有许多的 **section** 区。

* 名称：小写格式。
* 空间：只是一个 segment 段的子范围，但不再必须是 **page size** 的倍数。

常见的 **segments**

__TEXT：代码段，包括头文件、代码和常量。只读不可修改

__DATA：数据段，包括全局变量, 静态变量等。可读可写

__LINKEDIT：程序加载的元数据，以及代码签名等信息。只读不可修改。

### Mach-O Universal Files

**Mach-O** 通用文件，将多种架构的 **Mach-O** 文件合并而成。

* **header** 来记录结构和其在文件中的偏移量。
  * 占一页的空间
  * 不浪费，利于虚拟内存的实现
* segement 占多个分页